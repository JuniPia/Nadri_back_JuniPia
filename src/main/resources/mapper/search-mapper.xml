<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.co.iei.search.model.dao.SearchDao">
	<select id="selectKeyword" resultType="category">
		select keyword_no as id, keyword as name from search_keyword where keyword like '%'||
		<if test="query != null">
			#{query}
		</if>
		||'%'
		<if test="type != null and type.length>0">
			and place_type in (
			<foreach collection="type" item="item" separator=",">
				#{item}					
			</foreach>
			)
		</if>
	</select>
	<select id="selectPlaceByKeyword" resultType="int">
	  WITH matched_keywords AS (
	    SELECT *
	    FROM SEARCH_KEYWORD
	    WHERE KEYWORD LIKE '%' || #{query} || '%'
	  ),
	  filtered_place AS (
	    SELECT DISTINCT p.PLACE_ID
	    FROM PLACE_INFO p
	    WHERE EXISTS (
	      SELECT 1 FROM matched_keywords k
	      WHERE
	        (
	          k.PLACE_ID IS NOT NULL AND k.PLACE_ID = p.PLACE_ID
	        )
	        OR (
	          (k.CAT1 IS NOT NULL AND k.CAT1 = p.PLACE_CAT1)
	          OR (k.CAT2 IS NOT NULL AND k.CAT2 = p.PLACE_CAT2)
	          OR (k.CAT3 IS NOT NULL AND k.CAT3 = p.PLACE_CAT3)
	        )
	        OR (
	          k.AREA_CODE IS NOT NULL AND k.AREA_CODE = p.AREA_CODE
	        )
	    )
	    AND p.PLACE_TYPE_ID = #{type[0]} 
	    
	    UNION ALL
	    
	    SELECT p.PLACE_ID
	    FROM PLACE_INFO p
	    WHERE p.PLACE_TYPE_ID = #{type[0]}
	      AND p.PLACE_TITLE LIKE '%' || #{query} || '%'
	      AND NOT EXISTS (
	        SELECT 1 FROM matched_keywords
	      )
	  )
	  SELECT * FROM filtered_place WHERE ROWNUM &lt;= 30
	</select>

	<insert id="insertSearchLog">
		insert into search_log values(search_log_seq.nextval, #{query}, to_char(sysdate,'yyyy-mm-dd'))
	</insert>
	<select id="selectPopularByDate" resultType="log">
	  SELECT *
	  FROM (
	    SELECT
	      query,
	      COUNT(*) AS count
	    FROM search_log
	    WHERE searched_at = #{date}
	    GROUP BY query
	    ORDER BY count DESC
	  )
	  WHERE ROWNUM &lt;= 10
	</select>
	
	<select id="selectPopularByWeek" resultType="log">
	  SELECT *
	  FROM (
	    SELECT
	      query,
	      COUNT(*) AS count
	    FROM search_log
	    WHERE searched_at BETWEEN #{startDate} AND #{endDate}
	    GROUP BY query
	    ORDER BY count DESC
	  )
	  WHERE ROWNUM &lt;= 10
	</select>
	
	<select id="selectPopularByMonth" resultType="log">
	  SELECT *
	  FROM (
	    SELECT
	      query,
	      COUNT(*) AS count
	    FROM search_log
	    WHERE searched_at BETWEEN #{startDate} AND #{endDate}
	    GROUP BY query
	    ORDER BY count DESC
	  )
	  WHERE ROWNUM &lt;= 10
	</select>
	
	<select id="selectPopularByYear" resultType="log">
	  SELECT *
	  FROM (
	    SELECT
	      query,
	      COUNT(*) AS count
	    FROM search_log
	    WHERE searched_at BETWEEN #{startDate} AND #{endDate}
	    GROUP BY query
	    ORDER BY count DESC
	  )
	  WHERE ROWNUM &lt;= 10
	</select>
	<select id="searchPlaceTitle" resultType="category">
		select place_id as id, place_title as name from place_info where place_title like '%'||#{query}||'%'
	</select>
	<select id="selectPlanByPlace" resultType="int">
		select plan_no from trip_itinerary where end_location in 
			<foreach item="placeId" collection="placeList" open="(" separator="," close=")">
	            #{placeId}
	        </foreach>
	</select>
		<select id="selectReviewByPlace" resultType="int">
		select review_no from review where place_id in 
			<foreach item="placeId" collection="placeList" open="(" separator="," close=")">
	            #{placeId}
	        </foreach>
	</select>
</mapper>
